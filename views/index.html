<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home - Easy ToDo</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <header class="topbar">
      <nav>
        <ul class="nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/about">About</a></li>
          <li><a class="nav-link" href="/contact">Contact</a></li>
          <li><a class="nav-link" href="/search">Search</a></li>
        </ul>
      </nav>
    </header>

    <div class="logout-float">
      <p id="authStatus" class="hint hint-inline">Checking login status...</p>
      <button type="button" id="authBtn" class="btn btn-ghost">Login</button>
    </div>

    <h1 class="title">Easy ToDo Manager</h1>

    <section class="card">
      <h2>Add New Task</h2>

      <div class="task-form">
        <div class="task-row">
        <input type="text" id="todo-input" class="input" placeholder="What needs to be done?" />
        <button type="button" id="addBtn" class="btn btn-primary">Add Task</button>
        </div>

        <div class="task-row split">
        <input type="text" id="category-input" class="input" placeholder="Category (e.g., Study)" />
        <input type="number" id="priority-input" class="input" placeholder="Priority 1-5" min="1" max="5" />
        </div>

        <div class="task-row split">
        <input type="date" id="due-date-input" class="input" />
        <input type="number" id="time-hour-input" class="input" placeholder="Hour (0-23)" min="0" max="23" />
      </div>
      </div>

      <p class="hint">This page works with MongoDB API: <code>/api/tasks</code></p>
    </section>

    <section class="card">
      <h2>View Options</h2>
      <div class="row row-wide">
        <button type="button" id="toggleTitleOnlyBtn" class="btn btn-ghost">Titles only: OFF</button>

        <label class="check">
          <input type="checkbox" id="toggleCreatedAt" />
          <span>Show created date</span>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Filters & Sorting</h2>

      <div class="row row-wide">
        <input type="text" id="filterQuery" class="input" placeholder="Search by title..." />

        <select id="filterStatus" class="select">
          <option value="">All statuses</option>
          <option value="false">Not done</option>
          <option value="true">Done</option>
        </select>

        <select id="sortBy" class="select">
          <option value="created_at">Newest first</option>
          <option value="title">Title Aâ†’Z</option>
        </select>

        <button type="button" id="applyFiltersBtn" class="btn btn-secondary">Apply</button>
      </div>
    </section>

    <section class="card">
      <h2>Your Tasks</h2>
      <div id="tasksList" class="tasks"></div>
    </section>

    <section class="card">
      <h2>Quick API Test Links</h2>
      <ul class="links">
        <li><a href="/api/tasks" target="_blank">/api/tasks</a></li>
        <li><a href="/api/tasks/000000000000000000000000" target="_blank">/api/tasks/:id</a></li>
      </ul>
    </section>

    <footer class="footer">
      <p>Web Programming 2 - Easy ToDo Project</p>
    </footer>
  </div>

  <script>
    const API_URL = "/api/tasks";
    const AUTH_URL = "/auth";

    let titleOnly = false;
    let showCreatedAt = false;
    let isAuthenticated = false;

    function formatDate(value) {
      if (!value) return "";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return String(value);
      return d.toLocaleDateString();
    }

    function buildApiUrl() {
      const url = new URL(API_URL, window.location.origin);

      if (titleOnly) {
        url.searchParams.set("fields", ["title", "is_done", "created_at"].join(","));
      } else {
        const use = showCreatedAt
          ? ["title", "description", "is_done", "created_at", "category", "priority", "due_date", "time_hour", "owner"]
          : ["title", "description", "is_done", "category", "priority", "due_date", "time_hour", "owner"];
        url.searchParams.set("fields", use.join(","));
      }

      const q = document.getElementById("filterQuery").value.trim();
      const status = document.getElementById("filterStatus").value;
      const sortBy = document.getElementById("sortBy").value;

      if (q) url.searchParams.set("q", q);
      if (status !== "") url.searchParams.set("is_done", status);

      if (sortBy === "title") {
        url.searchParams.set("sort", "title");
        url.searchParams.set("order", "asc");
      } else {
        url.searchParams.set("sort", "created_at");
        url.searchParams.set("order", "desc");
      }

      return url.toString();
    }

    function renderEmpty(listEl) {
      listEl.innerHTML = `<p class="muted">No tasks yet. Add one above!</p>`;
    }

    function renderError(listEl, message) {
      listEl.innerHTML = `<p class="muted">Failed to load tasks. ${message ? "(" + message + ")" : ""}</p>`;
    }

    async function loadTasks() {
      const list = document.getElementById("tasksList");
      list.innerHTML = "";

      try {
        const res = await fetch(buildApiUrl());
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          renderError(list, `HTTP ${res.status} ${txt}`);
          return;
        }

        const data = await res.json();
        const tasks = Array.isArray(data) ? data : (data.items || []);

        if (!tasks.length) {
          renderEmpty(list);
          return;
        }

        for (const t of tasks) {
          const id = t._id;
          const done = !!t.is_done;

          const card = document.createElement("div");
          card.className = "task";

          const left = document.createElement("div");
          left.className = "task-left";

          const title = document.createElement("div");
          title.className = "task-title";
          title.textContent = t.title || "";

          if (done) title.classList.add("task-title-done");

          left.appendChild(title);

          if (!titleOnly && t.description) {
            const desc = document.createElement("div");
            desc.className = "task-desc";
            desc.textContent = t.description;
            left.appendChild(desc);
          }

          if (t.category) {
            const cat = document.createElement("div");
            cat.className = "task-meta";
            cat.textContent = `Category: ${t.category}`;
            left.appendChild(cat);
          }

          if (t.priority) {
            const pr = document.createElement("div");
            pr.className = "task-meta";
            pr.textContent = `Priority: ${t.priority}`;
            left.appendChild(pr);
          }

          if (t.due_date) {
            const due = document.createElement("div");
            due.className = "task-meta";
            due.textContent = `Due: ${formatDate(t.due_date)}`;
            left.appendChild(due);
          }

          if (t.time_hour !== null && t.time_hour !== undefined) {
            const th = document.createElement("div");
            th.className = "task-meta";
            th.textContent = `Hour: ${t.time_hour}:00`;
            left.appendChild(th);
          }

          if (t.owner) {
            const own = document.createElement("div");
            own.className = "task-meta";
            own.textContent = `Owner: ${t.owner}`;
            left.appendChild(own);
          }

          if (showCreatedAt && t.created_at) {
            const created = document.createElement("div");
            created.className = "task-meta";
            created.textContent = `Created: ${formatDate(t.created_at)}`;
            left.appendChild(created);
          }

          const actions = document.createElement("div");
          actions.className = "task-actions";

          const btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.className = "btn btn-secondary btn-small";
          btnEdit.textContent = "Edit";
          if (!isAuthenticated) {
            btnEdit.disabled = true;
            btnEdit.title = "Login required";
          }
          btnEdit.addEventListener("click", async () => {
            await editTask(id, t.title, t.description ?? null, done);
          });

          const btnToggle = document.createElement("button");
          btnToggle.type = "button";
          btnToggle.className = "btn btn-ghost btn-small";
          btnToggle.textContent = done ? "Undo" : "Done";
          if (!isAuthenticated) {
            btnToggle.disabled = true;
            btnToggle.title = "Login required";
          }
          btnToggle.addEventListener("click", async () => {
            await toggleTask(id, t.title, t.description ?? null, done);
          });

          const btnDelete = document.createElement("button");
          btnDelete.type = "button";
          btnDelete.className = "btn btn-danger btn-small";
          btnDelete.textContent = "Delete";
          if (!isAuthenticated) {
            btnDelete.disabled = true;
            btnDelete.title = "Login required";
          }
          btnDelete.addEventListener("click", async () => {
            await deleteTask(id);
          });

          actions.appendChild(btnEdit);
          actions.appendChild(btnToggle);
          actions.appendChild(btnDelete);

          card.appendChild(left);
          card.appendChild(actions);

          list.appendChild(card);
        }
      } catch (e) {
        renderError(document.getElementById("tasksList"), e?.message || "");
      }
    }

    async function addTask() {
      if (!isAuthenticated) {
        alert("Login required to add tasks");
        return;
      }

      const input = document.getElementById("todo-input");
      const title = input.value.trim();
      const category = document.getElementById("category-input").value.trim();
      const priority = document.getElementById("priority-input").value.trim();
      const dueDate = document.getElementById("due-date-input").value;
      const timeHour = document.getElementById("time-hour-input").value.trim();
      const description = prompt("Enter task description (optional):") || "";

      if (!title) {
        alert("Please enter a task title");
        return;
      }

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title,
          description,
          category: category || null,
          priority: priority ? Number(priority) : null,
          due_date: dueDate || null,
          time_hour: timeHour ? Number(timeHour) : null
        })
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        alert(`POST failed: ${res.status}\n${txt}`);
        return;
      }

      input.value = "";
      document.getElementById("category-input").value = "";
      document.getElementById("priority-input").value = "";
      document.getElementById("due-date-input").value = "";
      document.getElementById("time-hour-input").value = "";
      await loadTasks();
    }

    async function editTask(id, currentTitle, currentDescription, currentStatus) {
      const newTitle = prompt("Enter new title:", currentTitle);
      if (newTitle === null) return; // User cancelled

      const newDescription = prompt("Enter new description (optional):", currentDescription || "");
      if (newDescription === null) return; // User cancelled

      const newCategory = prompt("Enter category (optional):", "");
      if (newCategory === null) return;

      const newPriority = prompt("Enter priority 1-5 (optional):", "");
      if (newPriority === null) return;

      const newDueDate = prompt("Enter due date (YYYY-MM-DD) (optional):", "");
      if (newDueDate === null) return;

      const newTimeHour = prompt("Enter hour (0-23) (optional):", "");
      if (newTimeHour === null) return;

      if (!newTitle.trim()) {
        alert("Title cannot be empty");
        return;
      }

      const res = await fetch(`${API_URL}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: newTitle.trim(),
          description: newDescription.trim() || null,
          is_done: currentStatus,
          category: newCategory.trim() || null,
          priority: newPriority ? Number(newPriority) : null,
          due_date: newDueDate || null,
          time_hour: newTimeHour ? Number(newTimeHour) : null
        })
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        alert(`PUT failed: ${res.status}\n${txt}`);
        return;
      }

      await loadTasks();
    }

    async function toggleTask(id, title, description, currentStatus) {
      const res = await fetch(`${API_URL}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title,
          description,
          is_done: !currentStatus
        })
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        alert(`PUT failed: ${res.status}\n${txt}`);
        return;
      }

      await loadTasks();
    }

    async function deleteTask(id) {
      if (!confirm("Are you sure?")) return;

      const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        alert(`DELETE failed: ${res.status}\n${txt}`);
        return;
      }

      await loadTasks();
    }

    async function loadAuth() {
      const status = document.getElementById("authStatus");
      const btn = document.getElementById("authBtn");
      try {
        const res = await fetch(`${AUTH_URL}/me`);
        const data = await res.json();
        isAuthenticated = !!data.authenticated;
        status.textContent = isAuthenticated
          ? `Logged in as ${data.email || "user"}`
          : "Not logged in";
        btn.textContent = isAuthenticated ? "Logout" : "Login";
      } catch (e) {
        status.textContent = "Auth status unavailable";
        btn.textContent = "Login";
      }
    }

    async function handleAuthBtn() {
      if (!isAuthenticated) {
        window.location.href = "/login";
        return;
      }
      await fetch(`${AUTH_URL}/logout`, { method: "POST" });
      await loadAuth();
      await loadTasks();
    }

    document.getElementById("addBtn").addEventListener("click", addTask);
    document.getElementById("authBtn").addEventListener("click", handleAuthBtn);

    document.getElementById("toggleTitleOnlyBtn").addEventListener("click", () => {
      titleOnly = !titleOnly;
      document.getElementById("toggleTitleOnlyBtn").textContent =
        `Titles only: ${titleOnly ? "ON" : "OFF"}`;
      loadTasks();
    });

    document.getElementById("toggleCreatedAt").addEventListener("change", (e) => {
      showCreatedAt = e.target.checked;
      loadTasks();
    });

    document.getElementById("applyFiltersBtn").addEventListener("click", () => {
      loadTasks();
    });

    loadAuth().then(loadTasks);
  </script>
</body>
</html>
